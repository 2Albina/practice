## Как сделать предварительно cкомпилированные заголовочные файлы. Какой эффект они дают.

**Зачем нужны предварительно откомпилированные заголовочные файлы?**

При компиляции большого количества исходных файлов компилятор
выполняет множество раз одну и ту же работу по разбору тяжеловесных
заголовков (например, iostream). Основная идея заключается в том, чтобы
вынести эти тяжеловесные заголовки в отдельный файл, который
компилируется единожды и затем включается во все единицы
трансляции самым первым.

**Как работают?**

Файл, который содержит precompiled headers, имеет расширение ".pch". Файл может быть весьма большим и зависит от того, как много заголовочных файлов в нём раскрыто.

Файл \*.pch возникает после компиляции stdafx.cpp. Файл собирается с
ключом "/Yc". Этот ключ как раз и говорит компилятору, что нужно создать
precompiled headers. Файл stdafx.cpp может содержать одну строчку:
\#include "stdafx.h".

В файле "stdafx.h" находятся заголовочные файлы, которые будут заранее препроцессироваться.

**Как создать предкомипированный заголовочный файл в Visual Studio.**


Создала проект *with\_pch.*. В нём есть один Source.cpp файл.

Для всех .cpp файлов включаем использование precompiled headers. Это
делается на вкладке проект -&gt; свойства -&gt; свойства конфигурации
-&gt; c/c++ -&gt; предварительно откомпилированный заголовок:

\* Выставляем для параметра "Precompiled Header" значение "Use (/Yu)".

\* Для параметра "Precompiled Header File" указываем "stdafx.h".

\* Для параметра "Precompiled Header Output File" указываем
"\$(IntDir)\$(TargetName).pch".

Создаём и добавляем в проект файл stdafx.h. В него мы будем включать те
заголовочные файлы, которые хотим заранее препроцессировать.

Создаём и добавляем в проект файл stdafx.cpp. В нём одна единственная
строка: \#include "stdafx.h".

Для файла stdafx.cpp выставляем для параметра "Precompiled Header"
значение "Create (/Yc)".

Заголовочный файл "stdafx.h" должен включаться в \*.c/\*.cpp файл самым
первым.

Включать в "stdafx.h" только те файлы, которые никогда не изменяются или
меняются ОЧЕНЬ редко. Хорошими кандидатами являются заголовочные файлы
системных и сторонних библиотек.

**Сравнение проектов с использование предкомпилированного заголовка и
без.**

Рассматривается несколько случаев, которые отличаются разными сочетаниями включений заголовочных файлов в исходные файлы проекта.  
Сравниваются два проекта: с использованием предкомпилированного хедера и без.

1) один исходник.

В каждом проекте есть один .cpp файл.

|                            | Без предкомп. хедера | С предкомп. хедером | Эффект при использовании предкомп. хедера |
|----------------------------|----------------------|---------------------|-------------------------------------------|
| Время сборки проекта       | 2,100                | 1,029               | Уменьшение на 51%                         |
| Время компиляции 1.cpp     | 2,005                | 0,724               | Уменьшение на 53%                         |

Доп. инф.:
Время пересборки с предкомп. - 2,337
Время компиляции stdafx - 1,392

Видим, что время сборки проекта уменьшилось на 51%, что говорит об эффективности данного метода.


2) два исходника с одинаковыми заголовками.

В каждом проекте есть два .cpp файла, в которых подключены одни и те же заголовки.
В предкомп. хедер вынесены все заголовки.

|                            | Без предкомп. хедера | С предкомп. хедером | Эффект при использовании предкомп. хедера |
|----------------------------|----------------------|---------------------|-------------------------------------------|
| Время сборки проекта       | 3,120                | 1,244               | Уменьшение на 60%                         |
| Время компиляции 1.cpp     | 1,601                | 0,677               | Уменьшение на 58%                         |
| Время компиляции 2.cpp     | 1,564                | 0,572               | Уменьшение на 63%                         |

Доп. инф.:
Время пересборки с предкомп. - 2,463
Время компиляции stdafx - 1,345

Видим, что время сборки проекта уменьшилось на 60%,
следовательно, использование предкомпилированного хедера эффективно.


3) два исходника с частичным совпадением хедеров.

3.1) В каждом проекте есть два .cpp файла, в которых подключены как разные заголовки, так и одинаковые.  
В 1.cpp подключены - iostream, string, map; в 2.cpp - iostream, vector, algorithm.  
В предкомп. хедер вынесены заголовки со всего проекта, т.е. iostream, string, map, vector, algorithm.

|                            | Без предкомп. хедера | С предкомп. хедером | Эффект при использовании предкомп. хедера |
|----------------------------|----------------------|---------------------|-------------------------------------------|
| Время сборки проекта       | 2,987                | 1,174               | Уменьшение на 61%                         |
| Время компиляции 1.cpp     | 1,385                | 0,632               | Уменьшение на 54%                         |
| Время компиляции 2.cpp     | 1,301                | 0,558               | Уменьшение на 57%                         |

Доп. инф.:
Время пересборки с предкомп. - 2,681
Время компиляции stdafx - 1,574

Время сборки уменьшилось на 61%, что говорит об эффективности использования предкомп. хедера.  


3.2) В каждом проекте есть два .cpp файла, в которых подключены как разные заголовки, так и одинаковые.  
В 1.cpp подключены - iostream, string, map; в 2.cpp - iostream, vector, algorithm.  
В предкомп. хедер вынесен только общий заголовок, т.е. iostream.

|                            | Без предкомп. хедера | С предкомп. хедером | Эффект при использовании предкомп. хедера |
|----------------------------|----------------------|---------------------|-------------------------------------------|
| Время сборки всего проекта | 2,987                | 1,380               | Уменьшение на 54%                         |
| Время компиляции 1.cpp     | 1,385                | 0,658               | Уменьшение на 52%                         |
| Время компиляции 2.cpp     | 1,301                | 0,691               | Уменьшение на 47%                         |

Доп. инф.:
Время пересборки с предкомп. - 2,697
Время компиляции stdafx - 1,462 

Время сборки уменьшилось на 54%, т.е. использование предкомп. хедера все также влияет на сборку в лучшую сторону, хотя не так эффективно, как в случае 3.1). 
К тому же в больших проектах сложно выявить общие хедеры у исходных файлов, проще вынести все заголовки.

4) два исходника с разными хедерами.

4.1) В каждом проекте есть два .cpp файла, в которых подключены разные заголовки.  
В 1.cpp подключены - string, map; в 2.cpp - iostream, vector, algorithm.  
В предкомп. хедер вынесены заголовки со всего проекта, т.е. iostream, string, map, vector, algorithm.

|                            | Без предкомп. хедера | С предкомп. хедером | Эффект при использовании предкомп. хедера |
|----------------------------|----------------------|---------------------|-------------------------------------------|
| Время сборки проекта       | 2,590                | 1,306               | Уменьшение на 50%                         |
| Время компиляции 1.cpp     | 1,224                | 0,632               | Уменьшение на 48%                         |
| Время компиляции 2.cpp     | 1,310                | 0,787               | Уменьшение на 40%                         |

Доп. инф.:
Время пересборки с предкомп. - 3,269
Время компиляции stdafx - 1,877


Время сборки уменьшилось на 45%, что по-прежнему говорит об эффективности использования предкомп. хедера.  
Время компиляции исходных файлов увеличилось за счет того, 
что к каждому из них подключаются заголовки, которые не используются в данном файле. 

4.2) В каждом проекте есть два .cpp файла, в которых подключены разные заголовки.  
В 1.cpp подключены - string, map; в 2.cpp - iostream, vector, algorithm.  
Для каждого исходного файла существует отдельный предкомп. заголовочный файл, 
в который вынесены заголовки соответствующего исходного файла.

|                            | Без предкомп. хедера | С 2мя предкомп. хедерами | Эффект при использовании предкомп. хедера |
|----------------------------|----------------------|--------------------------|-------------------------------------------|
| Время сборки проекта       | 2,590                | 2,872                    | Увеличение на 11%                         |
| Время компиляции 1.cpp     | 1,224                | 1,456                    | Увеличение на 19%                         |
| Время компиляции 2.cpp     | 1,310                | 1,441                    | Увеличение на 10%                         |

Доп. инф.:
Время пересборки с предкомп. - 5,552
Время компиляции stdafx - 1,473
Время компиляции stdafx2 - 1,532 

Время сборки проекта увеличилось на 11%. 
Это говорит о том, что эффективнее использовать только один предкомпилированный заголовок, как в случае 4.1)

*Общий вывод:*  
Использование предкомпилированных заголовков позволяет уменьшить время сборки проекта на 50-60%.
Необходимо выносить все заголовки со всего проекта в общий хедер, который предварительно компилируется. 
Дополнительно уменьшаться время будет, если заголовок используется в нескольких исходных файлах.




*Источники:*  
<https://pvs-studio.ru/ru/blog/posts/cpp/0549/>  
<https://pvs-studio.ru/ru/blog/posts/cpp/0265/>  
<https://learn.microsoft.com/ru-ru/cpp/build/creating-precompiled-header-files?view=msvc-170>
<https://ru.wikipedia.org/wiki/Предварительно_откомпилированные_заголовки>
<https://pvs-studio.ru/ru/blog/posts/cpp/0265/>
<https://www.youtube.com/watch?v=trMdw6tCHlY>

