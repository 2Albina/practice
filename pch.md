## Как сделать предварительно cкомпилированные заголовочные файлы. Какой эффект они дают.

**Зачем нужны предварительно откомпилированные заголовочные файлы?**

При компиляции большого количества исходных файлов компилятор
выполняет множество раз одну и ту же работу по разбору тяжеловесных
заголовков (например, iostream). Основная идея заключается в том, чтобы
вынести эти тяжеловесные заголовки в отдельный файл, который
компилируется единожды и затем включается во все единицы
трансляции самым первым.

**Как работают?**

Файл, который содержит precompiled headers, имеет расширение ".pch". Файл может быть весьма большим и зависит от того, как много заголовочных файлов в нём раскрыто.

Файл \*.pch возникает после компиляции stdafx.cpp. Файл собирается с
ключом "/Yc". Этот ключ как раз и говорит компилятору, что нужно создать
precompiled headers. Файл stdafx.cpp может содержать одну строчку:
\#include "stdafx.h".

В файле "stdafx.h" находятся заголовочные файлы, которые будут заранее препроцессироваться.

**Как создать предкомипированный заголовочный файл в Visual Studio.**

Создала проект *with\_pch.*. В нём есть один Source.cpp файл.

Для всех .cpp файлов включаем использование precompiled headers. Это
делается на вкладке проект -&gt; свойства -&gt; свойства конфигурации
-&gt; c/c++ -&gt; предварительно откомпилированный заголовок:

\* Выставляем для параметра "Precompiled Header" значение "Use (/Yu)".

\* Для параметра "Precompiled Header File" указываем "stdafx.h".

\* Для параметра "Precompiled Header Output File" указываем
"\$(IntDir)\$(TargetName).pch".

Создаём и добавляем в проект файл stdafx.h. В него мы будем включать те
заголовочные файлы, которые хотим заранее препроцессировать.

Создаём и добавляем в проект файл stdafx.cpp. В нём одна единственная
строка: \#include "stdafx.h".

Для файла stdafx.cpp выставляем для параметра "Precompiled Header"
значение "Create (/Yc)".

Заголовочный файл "stdafx.h" должен включаться в исходные файл самым
первым.

Включать в "stdafx.h" только те файлы, которые никогда не изменяются или
меняются ОЧЕНЬ редко. Хорошими кандидатами являются заголовочные файлы
системных и сторонних библиотек.

**Сравнение проектов с использование предкомпилированного заголовка и
без.**

Рассматривается несколько случаев, которые отличаются разными сочетаниями включений заголовочных файлов в исходные файлы проекта.  
Сравниваются два проекта: с использованием предкомпилированного хедера и без.

1) один исходник.

В каждом проекте есть один .cpp файл.

|                            | Без предкомп. хедера | С предкомп. хедером | Эффект при использовании предкомп. хедера |
|----------------------------|----------------------|---------------------|-------------------------------------------|
| Время пересборки проекта   | 2,154                | 2,512               | Увеличение на 20%                         |
| Время сборки проекта       | 2,100                | 1,029               | Уменьшение на 51%                         |
| Время компиляции 1.cpp     | 2,005                | 0,724               | Уменьшение на 53%                         |

Время компиляции stdafx - 1,392

Видим, что время пересборки проекта увеличилось на 20%, а время компиляции исходников уменьшилось на 51-53%. Это говорит о том, что неэффективно использовать предварительную компиляцию хедеров, когда в проекте только один исходных файл.


2) два исходника с одинаковыми заголовками.

В каждом проекте есть два .cpp файла, в которых подключены одни и те же заголовки.
В предкомп. хедер вынесены все заголовки.

|                            | Без предкомп. хедера | С предкомп. хедером | Эффект при использовании предкомп. хедера |
|----------------------------|----------------------|---------------------|-------------------------------------------|
| Время пересборки проекта   | 3,173                | 2,601               | Уменьшение на 18%                         |
| Время сборки проекта       | 3,120                | 1,244               | Уменьшение на 60%                         |
| Время компиляции 1.cpp     | 1,601                | 0,677               | Уменьшение на 58%                         |
| Время компиляции 2.cpp     | 1,564                | 0,572               | Уменьшение на 63%                         |

Время компиляции stdafx - 1,345

Видим, что время пересборки проекта уменьшилось на 18%, а время компиляции исходников на 58-63%. Следовательно, использование предкомпилированного хедера эффективно, когда в проекте к исходным файлам подключаются одинаковые заголовки.

3) два исходника с частичным совпадением хедеров.

3.1) В каждом проекте есть два .cpp файла, в которых подключены как разные заголовки, так и одинаковые.  
В 1.cpp подключены - iostream, string, map; в 2.cpp - iostream, vector, algorithm.  
В предкомп. хедер вынесены заголовки со всего проекта, т.е. iostream, string, map, vector, algorithm.

|                            | Без предкомп. хедера | С предкомп. хедером | Эффект при использовании предкомп. хедера |
|----------------------------|----------------------|---------------------|-------------------------------------------|
| Время пересборки проекта   | 3,154                | 2,681               | Уменьшение на 15%                         |
| Время сборки проекта       | 2,987                | 1,174               | Уменьшение на 61%                         |
| Время компиляции 1.cpp     | 1,385                | 0,632               | Уменьшение на 54%                         |
| Время компиляции 2.cpp     | 1,301                | 0,558               | Уменьшение на 57%                         |

Время компиляции stdafx - 1,574

Время пересборки уменьшилось на 15%, а время компиляции исходников на 54-57%, что говорит об эффективности использования предкомп. хедера в ситуации, когда некоторые заголовки используются в нескольких исходных файлах.


3.2) В каждом проекте есть два .cpp файла, в которых подключены как разные заголовки, так и одинаковые.  
В 1.cpp подключены - iostream, string, map; в 2.cpp - iostream, vector, algorithm.  
В предкомп. хедер вынесен только общий заголовок, т.е. iostream.

|                            | Без предкомп. хедера | С предкомп. хедером | Эффект при использовании предкомп. хедера |
|----------------------------|----------------------|---------------------|-------------------------------------------|
| Время пересборки проекта   | 3,154                | 2,697               | Уменьшение на 15%                         |
| Время сборки проекта       | 2,987                | 1,380               | Уменьшение на 54%                         |
| Время компиляции 1.cpp     | 1,385                | 0,658               | Уменьшение на 52%                         |
| Время компиляции 2.cpp     | 1,301                | 0,691               | Уменьшение на 47%                         |

Время компиляции stdafx - 1,462 

Время пересборки уменьшилось на 15%. Что является неплохим результатом.
Но в больших проектах сложно выявить общие хедеры у исходных файлов, проще вынести все заголовки, как в случае 3.2. Поэтому этот способ имеет практическое применение только в небольших проектах, где незатруднительно искать общие хедеры.

4) два исходника с разными хедерами.

4.1) В каждом проекте есть два .cpp файла, в которых подключены разные заголовки.  
В 1.cpp подключены - string, map; в 2.cpp - iostream, vector, algorithm.  
В предкомп. хедер вынесены заголовки со всего проекта, т.е. iostream, string, map, vector, algorithm.

|                            | Без предкомп. хедера | С предкомп. хедером | Эффект при использовании предкомп. хедера |
|----------------------------|----------------------|---------------------|-------------------------------------------|
| Время пересборки проекта   | 2,776                | 3,269               | Увеличение на 15%                         |
| Время сборки проекта       | 2,590                | 1,306               | Уменьшение на 50%                         |
| Время компиляции 1.cpp     | 1,224                | 0,632               | Уменьшение на 48%                         |
| Время компиляции 2.cpp     | 1,310                | 0,787               | Уменьшение на 40%                         |

Время компиляции stdafx - 1,877

Время пересборки увеличилось на 15%, но уменьшилось время компиляции каждого исходника на 40-48%. 
Следовательно, неэффективно использовать предварительную компиляцию хедеров, когда в проекте два исходных файл, к которым подключены разные исходники.

**Зависимость изменения времени пересборки при увеличении количества исходных файлов** 

К исходникам подключены по одному заголовку, который не встречаться в других исходных файлах.

|                                  | **1 исходник** | **2 исходника** | **3 исходника** | **4 исходника** | **5 исходников** |
|----------------------------------|----------------|-----------------|-----------------|-----------------|------------------|
| **Время пересборки без хедера**  | 1,460          | 1,859           | 3,144           | 3,491           | 3,768            |
| **Время пересборки с хедером**   | 1,700          | 1,964           | 2,434           | 2,605           | 3,025            |
| **Изменение времени пересборки** | +16%           | +6%             | -23%            | -25%            | -20%             |

Из таблицы видно, что при увеличении числа исходников время пересборки при использовании предкомпилированного хедера уменьшается, а с одним-двумя исходниками увеличивается. Следовательно, предкомпилированные хедеры имеет смысл использовать в больших проектах.


*Общий вывод:*  
Использование предкомпилированных заголовков позволяет уменьшить время пересборки проекта на 15-18% и время сборки проекта (без компиляции stdafx) на 50-60%, если соблюдаются следующие условия:
* Необходимо выносить все заголовки со всего проекта в общий хедер, который предварительно компилируется. 
* При этом проект должен содержать больше двух исходных файлов.
* Дополнительно уменьшаться время будет, если заголовки используются в нескольких исходных файлах.



*Источники:*  
<https://pvs-studio.ru/ru/blog/posts/cpp/0549/>  
<https://pvs-studio.ru/ru/blog/posts/cpp/0265/>  
<https://learn.microsoft.com/ru-ru/cpp/build/creating-precompiled-header-files?view=msvc-170>  
<https://ru.wikipedia.org/wiki/Предварительно_откомпилированные_заголовки>  
<https://pvs-studio.ru/ru/blog/posts/cpp/0265/>  
<https://www.youtube.com/watch?v=trMdw6tCHlY>
